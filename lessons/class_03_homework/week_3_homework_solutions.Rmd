---
title: "BIDA 405 - week 3"
subtitle: "homework assignment #3: solutions"
author: "Martin Monkman"
date: "2020/09/20"
output: html_notebook
---

```{r setup}

library(tidyverse)

library(validate)

```

# A. Using {validate} 

Load the `retailers` data (housed in the {validate} package)

(Note that we use the function `data()` to access data tables that are included in an R package.)

```{r}

data(retailers)

```


Use the `check_that()` function to check the following assumptions:

* Turnover is larger than or equal to zero (Turnover can't be a negative number)

* The costs per staff are below 50,000 (This is a "sanity check"; in general in the retail sector, we would expect costs to be below this threshold.)

```{r}

cf <- check_that(retailers, turnover > 0, staff.costs/staff < 50)
summary(cf)

```


> Q1. Summarize what this table is telling us.


Now we will create an object using the `validator()` function, with the two tests above plus three more: 

```{r}

val_retail <- validator(
    turnover > 0, staff.costs / staff < 50,
    total.costs >= 0,
    staff >= 0,
    turnover + other.rev == total.rev
)

val_retail

```

> Q2a. Write text descriptions of each of the three additional tests, stating the assumption about the variable(s) being tested
>

> Q2b. 
>
>* Run the validator scripts against the `retailers` data
>
>* Create a summary table of the results of the validation tests, and 
>
>* Write a short text description of the passes, fails and NAs of each test (write an interpretation of what each test summary means.)


```{r}
# solution
cf <- confront(retailers, val_retail)
cf

summary(cf)

```




> Q3. Create a single `validator()` object for the `retailers` dataset with the following rules (or tests):
>
>* Non-negativity for the variables `staff`, `staff.cost`, and `total.cost`
>
>* `if (staff > 0) staff.cost > 0`
>
>* The total cost must be larger than or equal to the staff cost
>

## Solution

```{r}

Q3v <- validator(
    staff > 0,
    staff.costs > 0,
    total.costs > 0,
    if (staff > 0) staff.cost > 0,
    total.costs >= staff.costs)

cf_retail <- confront(retailers, Q3v)

cf_retail

summary(cf_retail)
```



>Confront this validator object with the `retailers` dataset and summarize the result with `summary`. 

> Answer the following questions:
>
>Q4a. Which rule is violated most often?
>
>Q4b. Which rule resulted in the most missings? Why do you think this is?

solution:
V5, total cost > staff costs (it combines the missings from both variables)

>
>Q4c. Discuss the expression for the conditional rule on `staff` and `staff.cost`

solution:
The variable is `staff.costs` with an "s" at the end, so the typo is throwing an error


# B. Remove duplicates

Here's a twist on the Canadian city population table--the CMAs and CAs on Vancouver Island.
 
```{r}

vanisle_city <- tribble(
  ~city, ~province, ~population,
  "Campbell River", "BC", 41845,
  "Courtenay", "BC", 59268,
  "Duncan", "BC", 48251,
  "Nanaimo", "BC", 115743,
  "Parksville", "BC", 30707,
  "Port Alberni", "BC", 26794,
  "Victoria", "BC", 402271,
  "Victoria", "BC", 396110
)

vanisle_city

```

>Q5. What happens when we use `distinct(province, .keep_all = TRUE)` ?_


```{r}
# solution
vanisle_city %>% 
  distinct(province, .keep_all = TRUE)

```

# C. BC COVID cases

> This function reads the CSV file with the BC COVID-19 cases by age, as reported on 2020-08-24. The code chunk below reads the file, and then tabulates the cases by the age groups. (Data source: https://github.com/jeanpaulrsoucy/covid-19-canada-gov-data/blob/master/bc/case-data/BCCDC_COVID19_Dashboard_Case_Details_2020-08-24_20-45.csv)

> This chunk shows how the "10-19" age group category was converted to a date by Excel, so now it reads "19-Oct".


```{r}

bccovid <- read_csv("BCCDC_COVID19_Dashboard_Case_Details_2020-08-24_20-45.csv")

bccovid %>% 
    group_by(Age_Group) %>% 
    tally()

```

>Q6. Use a {dplyr} `case_when()` function to correct this error in labeling.

```{r}

bccovid <- bccovid %>% 
  mutate(age_grp = case_when(
    Age_Group == "19-Oct" ~ "10-19",
    TRUE ~ Age_Group
  ))

bccovid %>% 
    group_by(age_grp) %>% 
    tally()


```



-30-
