---
title: "Tables"
subtitle: "formatting for reporting"
output:
  html_document
---

<!-- 
This file by Martin Monkman is licensed under a Creative Commons Attribution 4.0 International License. 
-->

```{r setup, message=FALSE, warning=FALSE}
# data wrangling
library(tidyverse)

library(readr)     # for read_csv()
library(magrittr)  # for pipes

# data
library(palmerpenguins)

# table formatting
library(kableExtra)
```

## Objectives

* Demonstrate options for formatting tables in R Markdown

## Population of Canada

Creating a table that looks like the one published by Statistics Canada.

(Source: Statistics Canada. [Table 17-10-0009-01 Population estimates, quarterly](https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1710000901))

![Canada, Quarterly Population](df_17100009_2020-10-08.JPG)


First, load the data

```{r}

df_17100009 <- read_csv("data/17100009.csv")

```

```{r}

head(df_17100009)

```

We want `REF_DATE`, but only the last 5 dates. We also want `GEO` and `VALUE`. Time to select, and then filter.

```{r}

df_pop <- df_17100009 %>% 
  select(REF_DATE, GEO, VALUE)
head(df_pop)

```

Step 1: what are the last 5 quarters?

```{r}
last_five_q <- df_pop %>% 
  distinct(REF_DATE) %>% 
  slice_max(REF_DATE, n = 5)
  
last_five_q

```


Now we need to extract the values that are in the first (and only) column of our dataframe `last_five_q`. (See [Roger Peng, _R Programming for Data Science_ 9.1 Subsetting a Vector](https://bookdown.org/rdpeng/rprogdatascience/subsetting-r-objects.html))

```{r}

list_five <- last_five_q[[1]]
list_five
```

Now we can use that list to filter the dataframe.

```{r}
df_pop <- 
df_pop %>%
  filter(REF_DATE %in% list_five)

head(df_pop)
```

### pivot to wider

The next step is to pivot the table, in order to get the correct structure. For this, we need the package {tidyr} (part of the {tidyverse} package of packages) and the function `pivot_wider()`

```{r}

df_pop_pivot <- df_pop %>% 
  pivot_wider(id_cols = GEO, names_from = REF_DATE, values_from = VALUE)

df_pop_pivot
```

## Table Formatting

At this point we can move on to formatting the table. In its basic knitted form it's a bit uninspiring, and not what we would want to use in a handout.


The first possible change is in the YAML: we can add

`output:`

  `html_document:`
  
    `df_print: paged`

to set a "paged" option to our dataframe output.


```{r}
df_pop_pivot
```

It doesn't look too bad, but it is "paged" at 10 rows, and has the variable type showing. It's not quite there yet.

The second option is to use the kable functions in {rmarkdown}. Again, we need to change the option in the YAML:

`output:`

  `html_document:`
  
    `df_print: kable`

This will print all 14 rows in a single view.


```{r}
df_pop_pivot 
```

### kable & {kableExtra} .

Using kable (part of {knitr}, which is behind R Markdown) and the package {kableExtra} opens up the possibility of a lot more formatting.

See this vignette for more details: https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html

Also the RMarkdown Cookbook has some good reference material: https://bookdown.org/yihui/rmarkdown-cookbook/kable.html

```{r}
df_pop_pivot %>% 
  kbl() %>% # to turn the dataframe into a kable object we can use repeatedly
  kable_paper("hover", full_width = TRUE)  # the "paper" option

```

In the following example, we will first change the column names to be consistent with Statistics Canada. Note that we will create a kable object with these names which we can easily reference.

Then with our new object we use the "striped" option for a "paper" table, bold the most recent column, and shade the British Columbia row.

```{r}

kbl_pop <- df_pop_pivot %>% 
  kable(col.names = c("Geography", 
                "Q3 2019", "Q4 2019", 
                "Q1 2020", "Q2 2020", "Q3 2020"),
        format.args = list(big.mark = ",", scientific = FALSE))

kbl_pop %>%  
  kable_paper("striped", full_width = F) %>% # the "paper" option for style
  column_spec(6, bold = TRUE) %>% 
  row_spec(11, bold = TRUE, color = "#FFD800", background = "#002680") 



```


Note that if we want to make changes to the head, we reference row number 0. 

```{r}
kbl_pop %>%  
  kable_paper("striped", full_width = F) %>% 
  row_spec(0, bold = TRUE, color = "#FFD800", background = "#002680", font_size = 18)
```


There is an option to add a footnote to the table. Here I used a number, but there's also an option for `general`, `number`, `alphabet`, and `symbol`.

```{r}

kbl_pop %>%  
  kable_classic("striped", full_width = F) %>% 
  footnote(number = c("Source: Statistics Canada, Table 17-10-0009-01 Population estimates, quarterly",
                      "Downloaded 2020-10-07")) 
  

```


#### Putting it all together



```{r}

kbl_pop <- df_pop_pivot %>% 
  kable(col.names = c("Geography", 
                "Q3 2019", "Q4 2019", 
                "Q1 2020", "Q2 2020", "Q3 2020"),
        format.args = list(big.mark = ",", scientific = FALSE))

kbl_pop %>%  
  # overall table style
  kable_classic("striped", full_width = F) %>% 
  # format header row
  row_spec(0, bold = TRUE, color = "#ffffff", background = "#000000", font_size = 18) %>% 
  # BC row
  row_spec(11, italic = TRUE) %>%
  # most recent column
  column_spec(6, bold = TRUE) %>% 
  # footnotes (with symbol)
  footnote(alphabet = c("Source: Statistics Canada, Table 17-10-0009-01 Population estimates, quarterly",
                      "Downloaded 2020-10-07")) %>% 
  # add grouping for provinces and territories
  pack_rows("Provinces", 2, 11) %>% 
  pack_rows("Territories", 12, 14)
  
```




There are many other options:

* conditional formatting

* grouping columns and rows

* tooltips and popover messages

* changing missing values from "NA" to another representation (for example, a hyphen or double asterix)



***

## REFERENCE

https://rfortherestofus.com/2019/11/how-to-make-beautiful-tables-in-r/

### Packages

{kable}: https://readr.tidyverse.org/index.html

{dt}: 

{reactable}

{flextable}

{huxtable}

{pixiedust}

---

Before we filter, let's use `case_when` to create our quarter variable, and split out the year.

Note that the uses a different pipe symbol, which returns the results of the pipe to the same object.

```{r evaluate = FALSE}

df_pop %<>%
  mutate(YEAR = str_sub(REF_DATE, 1, 4)) %>% 
  mutate(quarter = case_when(
    "01" == str_sub(REF_DATE, 6, 7) ~ "Q1",
    "04" == str_sub(REF_DATE, 6, 7) ~ "Q2",
    "07" == str_sub(REF_DATE, 6, 7) ~ "Q3",
    "10" == str_sub(REF_DATE, 6, 7) ~ "Q4",
    TRUE ~ NA_character_
  ))

df_pop

```
