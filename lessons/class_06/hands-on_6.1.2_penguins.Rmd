---
title: "Disclosure"
subtitle: ""
output:
  html_document:
    df_print: paged
---

<!-- 
This file by Martin Monkman is licensed under a Creative Commons Attribution 4.0 International License. 
-->

```{r setup, message=FALSE, warning=FALSE}
# data wrangling
library(tidyverse)

library(readr)
library(magrittr)

library(palmerpenguins)
```

## Objectives

* Demonstrate understanding of statistical disclosure


## Making sure that individuals are not identifiable

Often when we are sharing our data—whether the individual records or summary tables of our data—we have to be aware that we run the risk of disclosing personal information. 

We also have to be aware that there is other data in circulation that might help identify an individual, even if we create summary tables. And it doesn't take very many grouping variables before we start to risk disclosure.

We can see that with the {palmerpenguins} data. 

## Read the data

```{r}
penguins <- palmerpenguins::penguins
  
```

First let's print the summary statistics for the penguins.

```{r}
summary(penguins)

```

No single penguin can be identified in this summary table. .


How many demographic characteristics can we tabulate before we get a unique individual?

```{r}

penguins %>% 
  group_by(species) %>% 
  summarise(n = n())

penguins %>% 
  group_by(island) %>% 
  summarise(n = n())

penguins %>% 
  group_by(sex) %>% 
  summarise(n = n())

```

```{r}

penguins %>% 
  group_by(island, species, sex) %>% 
  summarise(n = n()) %>% 
  arrange(n)


```

So let's choose to omit the records where sex is `NA`--perhaps our research question is to see how much weight varies by sex, so penguins without a value in that column isn't going to help. We will also select only the species, sex, and weight variables.

For our next step, we will group the penguins into weight quartiles--grouping the penguins so that the smallest 25% are in one group, the next 25% are in the next group, and so on. In total, there will be 83 or 84 penguins in each quartile.

```{r}
# filter and mutate quartile groupings
penguins_2 <- penguins %>%
  filter(!is.na(sex)) %>% 
  select(species, sex, body_mass_g) %>% 
  mutate(bm_quart = as.integer(gtools::quantcut(body_mass_g, q=4))) %>% 
  mutate(bm_quart = as.factor(bm_quart))
    

```

Here's a quick visualization of the distribution by weight, showing the quartile cut points:


```{r}

q <- quantile(penguins$body_mass_g, na.rm = TRUE)

# density plot with lines showing quartiles
ggplot(penguins_2, aes(x = body_mass_g)) +
  geom_density() +
  annotate(geom="text", x=q, y=0, label=names(q)) +
  theme(text = element_text(size=10)) +
  geom_vline(xintercept=q, linetype = "longdash")


# modified from https://stackoverflow.com/questions/34029811/fill-different-colors-for-each-quantile-in-geom-density-of-ggplot

```

We can now drop the `body_mass_g` variable, so all we have is species, sex, and the weight group.

```{r}
penguins_3vars <- penguins_2 %>%
  select(species, sex, bm_quart)
penguins_3vars

readr::write_rds(penguins_3vars, "penguins_3vars.rds")
```

Is this data set anonymized? That is, can you identify any one penguin?

To find out, we can tally the penguins by the three variables.

```{r}
penguins_3vars %>% 
  group_by(species, sex, bm_quart) %>% 
  summarise(n = n())

```

There are four penguins that are identifiable by these three variables!

Skill-testing question: using the what is the flipper length of the female Chinstrap penguin in the 3rd quartile?

We can use the two demographic variables and our knowledge of the quartile cut points in a `filter()` to identify the penguin.

```{r}

penguins %>% 
  filter(species == "Chinstrap",
         sex == "female",
         body_mass_g > 4050)
  
  
```


---

Here's a modified version of the table with only 3 variables:

* The records with `NA` values have been filtered out, so the file is now 333 rather than 344 records. 

* There are three variables:

  - species and sex are from the original table
  
  - `bm_quart` is the quartile ranking of the body mass measure. There are four values: the lightest 25% of the penguins are coded as 1, the next weight group are coded 2, and so on


```{r}
penguins_3vars <- readr::read_rds("penguins_3vars.rds")
  
```

First let's print the summary statistics for the penguins.

```{r}
summary(penguins_3vars)

```


***

## REFERENCE

### Packages

{readr}: https://readr.tidyverse.org/index.html

{readxls}: 

