---
title: 'Import data: web data'
output:
  html_document:
    df_print: paged
---

<!-- 
This file by Martin Monkman is licensed under a Creative Commons Attribution-ShareAlike 4.0 International License. 
https://creativecommons.org/licenses/by-sa/4.0/

Elements are drawn from the reference materials for the packages
* {haven} -- https://haven.tidyverse.org/
* {labelled} -- http://larmarange.github.io/labelled/reference/index.html


-->



# Webscraping {#webscraping}

As we've seen yesterday, we can access data on the web through various R packages, and using APIs. These tools give us access to data tables that are published as data tables. But what if the data you want populates a web page in a non-tabular format?


* The [Billboard Hot 100 music chart](https://www.billboard.com/charts/hot-100) is updated weekly.

* Weather forecast pages are updated hourly or daily.



## Getting started

Run this code chunk:

```{r setup}
library(tidyverse)  
# 
library(datapasta) # copy-paste!
#
library(rvest)     # webscraping
```


## Copy-paste


### Tangent: making a tibble

In R, we can build a data table by writing some code with instructions to take some numbers, characters, etc. and assemble it into columns (variables) and rows (individual records or observations).

In this example, we will use the {base} R function `data.frame` to create a table with two variables, `x` and `y`. `x` will be the integers from 1 to 5, and `y` will be equal to 2.

```{r}

df_five <- data.frame(
  x = 1:5,
  y = 2
)

df_five

```

```{r}

df_five$z <- df_five$x * df_five$y

df_five 

```



The {tidyverse} approach to this is a _tibble_, which is either the phonetic sounding out of the letters "t-b-l" (sometimes used as an extension for a table file).

In _R for Data Science_ there is [an entire chapter devoted to tibbles](https://r4ds.had.co.nz/tibbles.html)

One of the upsides to using tibbles is that it allows us to run calculations on variables we've just created--so we can add the syntax for our `z` variable right away.

```{r}

tibble(
  x = 1:5,
  y = 2,
  z = x^2 + y
)
```

We can also create a _tribble_, which is a _transposed tibble_ (and also a _Star Trek_ reference).

![tribble](tribble.jpg)

In this example, we have the names of the Star Fleet captains who were central to the first four _Star Trek_ t.v. series, the actor who portrayed that character (two variables that are character type, pardon the pun), and the year the series first appeared (a numeric variable). 

Note that in the way that the `tribble()` function code is structured, the variables are listed first and are each identified with a tilde ~. This is then followed by each row's contents. In this way, it is visually structured more like the table we want. 

```{r}

captains <-
tribble(
  ~"captain", ~"actor", ~"first_appeared",
  "Kirk", "William Shatner", 1966,
  "Picard", "Patrick Stewart", 1987,
  "Sisko", "Avery Brooks", 1993,
  "Janeway", "Kate Mulgrew", 1995
)

captains
```


```{r}
max(captains$`first appeared`)

max(captains$"first appeared")

max(captains$first_appeared)

```


### ...back to copy & paste

This is perhaps the simplest approach to get data from the web...select the range of what you want, and paste it to the file you want. However, how can you paste a web data table directly into a structure that R can use?  This is where {datapasta} comes in. (Of course, it can be used to copy-paste from other sources, as well. For example, I made an R tibble from the PDF of the class list.)


Reference page: https://milesmcbain.github.io/datapasta/

Once you've installed {datapasta} with `install.packages("datapasta")`, it will appear in your RStudio "Addins"

> Tangent: RStudio Addins and Keyboard Shortcuts

> * [RStudio addins, or how to make your coding life easier](https://towardsdatascience.com/rstudio-addins-or-how-to-make-your-coding-life-easier-6b627c7b2240)

> * [Keyboard shortcuts](https://support.rstudio.com/hc/en-us/articles/200711853-Keyboard-Shortcuts)

> [Customizing Keyboard Shortcuts](https://support.rstudio.com/hc/en-us/articles/206382178-Customizing-Keyboard-Shortcuts)



Let's practice: we will copy and paste the Major League Baseball stats for the baseball player Hyun Jin Ryu, the first player from South Korea to be the starting pitcher in a World Series Game.

His player page at baseball-reference.com is https://www.baseball-reference.com/players/r/ryuhy01.shtml

We can select the range in the "Standard Pitching" table, and then hit "<ctrl> C" (or "<cmd> C" on a Mac) to copy the range to our clipboard.

If we were to paste it to a text editor, it would look like this:


`Year	Age	Tm	Lg	W	L	W-L%	ERA	G	GS	GF	CG	SHO	SV	IP	H	R	ER	HR	BB	IBB	SO	HBP	BK	WP	BF	ERA+	FIP	WHIP	H9	HR9	BB9	SO9	SO/W	Awards`
`2013	26	LAD	NL	14	8	.636	3.00	30	30	0	2	1	0	192.0	182	67	64	15	49	4	154	1	0	5	783	119	3.24	1.203	8.5	0.7	2.3	7.2	3.14	RoY-4`
`2014	27	LAD	NL	14	7	.667	3.38	26	26	0	0	0	0	152.0	152	60	57	8	29	2	139	3	0	2	631	103	2.62	1.191	9.0	0.5	1.7	8.2	4.79	`
`2016	29	LAD	NL	0	1	.000	11.57	1	1	0	0	0	0	4.2	8	6	6	1	2	1	4	0	0	0	24	37	5.50	2.143	15.4	1.9	3.9	7.7	2.00	`
`2017	30	LAD	NL	5	9	.357	3.77	25	24	1	0	0	1	126.2	128	58	53	22	45	3	116	4	1	4	541	110	4.74	1.366	9.1	1.6	3.2	8.2	2.58	`
`2018	31	LAD	NL	7	3	.700	1.97	15	15	0	0	0	0	82.1	68	23	18	9	15	1	89	1	0	0	324	198	3.00	1.008	7.4	1.0	1.6	9.7	5.93	`
`2019	32	LAD	NL	14	5	.737	2.32	29	29	0	1	1	0	182.2	160	53	47	17	24	2	163	4	0	0	723	179	3.10	1.007	7.9	0.8	1.2	8.0	6.79	AS,CYA-2,MVP-19`
`2020	33	TOR	AL	3	1	.750	3.19	9	9	0	0	0	0	48.0	41	19	17	6	14	0	53	1	0	1	198	143	3.55	1.146	7.7	1.1	2.6	9.9	3.79	`


We might be able to fuss about with this and make it work (remember about space delimited plain text files!). I've pasted it into a .txt file, which we can read in using the `read_table()` function in {readr}, which uses the spaces as a delimiter:

```{r}

readr::read_table("hyun_jin_ryu.txt")

```

Hmm...that didn't work. But this gives us a significant clue—each column is separated by `\t`. This is the coding for a tab—this is a tab separated file. We can use `read_tsv()` instead.

```{r}

readr::read_tsv("hyun_jin_ryu.txt")

```


An alterative is {datapasta}, which allows us to paste it directly into our R code chunk.

Using the addin or the keyboard shortcut for a data.frame, it looks like this:

```{r}

tibble::tribble(
  ~Year, ~Age,   ~Tm,  ~Lg,  ~W, ~L, ~`W-L%`,  ~ERA,  ~G, ~GS, ~GF, ~CG, ~SHO, ~SV,   ~IP,   ~H,  ~R, ~ER, ~HR, ~BB, ~IBB,  ~SO, ~HBP, ~BK, ~WP,  ~BF, ~`ERA+`, ~FIP, ~WHIP,  ~H9, ~HR9, ~BB9, ~SO9, ~`SO/W`,           ~Awards,
  2013L,  26L, "LAD", "NL", 14L, 8L,   0.636,     3, 30L, 30L,  0L,  2L,   1L,  0L,   192, 182L, 67L, 64L, 15L, 49L,   4L, 154L,   1L,  0L,  5L, 783L,    119L, 3.24, 1.203,  8.5,  0.7,  2.3,  7.2,    3.14,           "RoY-4",
  2014L,  27L, "LAD", "NL", 14L, 7L,   0.667,  3.38, 26L, 26L,  0L,  0L,   0L,  0L,   152, 152L, 60L, 57L,  8L, 29L,   2L, 139L,   3L,  0L,  2L, 631L,    103L, 2.62, 1.191,    9,  0.5,  1.7,  8.2,    4.79,                NA,
  2016L,  29L, "LAD", "NL",  0L, 1L,       0, 11.57,  1L,  1L,  0L,  0L,   0L,  0L,   4.2,   8L,  6L,  6L,  1L,  2L,   1L,   4L,   0L,  0L,  0L,  24L,     37L,  5.5, 2.143, 15.4,  1.9,  3.9,  7.7,       2,                NA,
  2017L,  30L, "LAD", "NL",  5L, 9L,   0.357,  3.77, 25L, 24L,  1L,  0L,   0L,  1L, 126.2, 128L, 58L, 53L, 22L, 45L,   3L, 116L,   4L,  1L,  4L, 541L,    110L, 4.74, 1.366,  9.1,  1.6,  3.2,  8.2,    2.58,                NA,
  2018L,  31L, "LAD", "NL",  7L, 3L,     0.7,  1.97, 15L, 15L,  0L,  0L,   0L,  0L,  82.1,  68L, 23L, 18L,  9L, 15L,   1L,  89L,   1L,  0L,  0L, 324L,    198L,    3, 1.008,  7.4,    1,  1.6,  9.7,    5.93,                NA,
  2019L,  32L, "LAD", "NL", 14L, 5L,   0.737,  2.32, 29L, 29L,  0L,  1L,   1L,  0L, 182.2, 160L, 53L, 47L, 17L, 24L,   2L, 163L,   4L,  0L,  0L, 723L,    179L,  3.1, 1.007,  7.9,  0.8,  1.2,    8,    6.79, "AS,CYA-2,MVP-19",
  2020L,  33L, "TOR", "AL",  3L, 1L,    0.75,  3.19,  9L,  9L,  0L,  0L,   0L,  0L,    48,  41L, 19L, 17L,  6L, 14L,   0L,  53L,   1L,  0L,  1L, 198L,    143L, 3.55, 1.146,  7.7,  1.1,  2.6,  9.9,    3.79,                NA
  )


```


Note that not all tables will paste elegantly! Using {datapasta} to paste the latest COVID-19 data in the "Reported Cases and Deaths by Country, Territory, or Conveyance" table at worldometers.info  https://www.worldometers.info/coronavirus/ doesn't work very well. 

* It seems the header row gets split in two

* The first row (with the total for the World) has many missing values.

* The numbers with commas get read as characters (the commas are in the paste)

Excel does a better job of interpreting the table! So your solution might be to paste the table into Excel and then read the Excel results.

```{r}
tibble::tribble(
       ~Other,        ~Total,
      "Cases",         "New",
      "Cases",       "Total",
     "Deaths",         "New",
     "Deaths",       "Total",
  "Recovered",      "Active",
      "Cases",    "Serious,",
   "Critical",  "Tot Cases/",
     "1M pop",     "Deaths/",
     "1M pop",       "Total",
      "Tests",      "Tests/",
     "1M pop",  "Population",
      "World",  "28,931,434",
   "+282,391",     "924,080",
     "+4,983",  "20,800,209",
  "7,207,145",      "60,887",
      "3,712",       "118.6",
           NA,            NA,
          "1",         "USA",
  "6,676,601",     "+39,282",
    "198,128",        "+707",
  "3,950,354",   "2,528,119",
     "14,366",      "20,147",
        "598",  "91,703,503",
    "276,720", "331,393,984"
  )


```



More "how to datapasta" https://milesmcbain.github.io/datapasta/articles/how-to-datapasta.html



## Readings

Samuel E. Buttrey and Lyn R. Whitaker, _A Data Scientist's Guide to Acquiring, Cleaning and Managing Data in R_ (2017):

* Chapter 6, "Getting Data into and out of R"

* [UVic library link](https://learning-oreilly-com.ezproxy.library.uvic.ca/library/view/a-data-scientists/9781119080022/c06.xhtml#c6)




## {polite} package

https://dmi3kno.github.io/polite/index.html

[@R-polite]



## {rvest} package

[@R-rvest]


[@doi:10.1080/10691898.2020.1787116]


