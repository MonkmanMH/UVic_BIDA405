---
title: "Import data: accessing data from the web"
output: html_notebook
---

<!-- 
This file by Martin Monkman is licensed under a Creative Commons Attribution-ShareAlike 4.0 International License. 
https://creativecommons.org/licenses/by-sa/4.0/

Elements are drawn from the reference materials for the packages
* {haven} -- https://haven.tidyverse.org/
* {labelled} -- http://larmarange.github.io/labelled/reference/index.html

Data is from the University of Sheffield Mathematics and Statistics Help's "Datasets for Teaching"
https://www.sheffield.ac.uk/mash/statistics/datasets
The data is licensed under a Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International
https://creativecommons.org/licenses/by-nc-sa/4.0/

-->


# Getting started

There is a lot of valuable data out there on the internet, just waiting for curious data analysts to pull nuggets of insight out of it. There are a variety of ways to get it; in some cases, you can download a CSV or Excel file and then read that into R.

But the brilliant people that make up the R community have made our life a whole lot easier by creating packages that allow us to write R scripts that link directly to data we want. This is particularly valuable if you are accessing a data set that gets updated regularly (say, a weekly financial report or the results of a monthly survey).

In this section, we will explore two examples that allow access to the data repository hosted by Statistics Canada, and the British Columbia Government's open data catalogue. There are many other tools available; some are listed at the bottom of this page.

Run this code chunk to load the packages we need:

```{r setup, message = FALSE}
library(tidyverse)  

# 
library(cansim)     # access Statistics Canada's CANSIM data repository
library(bcdata)     # access the BC Government's open data catalogue
```




## Statistics Canada's CANSIM

Statistics Canada, a department of the Government of Canada, provides a socioeconomic time series database known as "CANSIM". The data posted to the database is most of the aggregate data collected by Statistics Canada on a regular basis, such as the Labour Force Survey (from which we get updates on the unemployment rate), the Consumer Price Index Survey (about inflation), and health-related information from pregnancy and births to life expectancy and deaths.

One of the many tables related to international travel that is published in CANSIM is "Table: 24-10-0006-01 Non-resident travellers entering Canada, by country of residence, seasonally adjusted". 

The webpage for the table, showing the most recently available data, is here: https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=2410000601


Here's a screenshot of the table, showing the number of people arriving by their continent of residence. 

![table](cansim_24-10-0006-01_2020-09-10.JPG)


This table might be useful if you were developing a marketing campaign and you wanted to understand where tourists are coming from—the biggest markets and the fastest growing. But as shown, it is at too high a level; this is Canada by continent. For our purposes, we need to see specific country, those entering Canada via British Columbia, and a longer time series. 

We could use the filters and fiddle around making sure we got the right selections and then download the data, but if we have to do that next month it is going to be inefficient. We could also first click on the "download options" button and select "download entire table..." but again, this is not the most efficient way to do this, since there are a few manual steps we have to take and then open the file into R and filter to select the series we want. 

This is where the {cansim} package comes it. 

Step 1: download the data.

* the `get_cansim()` function takes the table number as the parameter, and connects to CANSIM and downloads the data into an R dataframe.

```{r}

travellers <- get_cansim("24-10-0006-01")

```

We will come back to filtering and variable selection along with working with date fields later, but here's the code in R using the functions of the {dplyr} package to filter for the British Columbia cases during the month of June 2020:

```{r}

travellers_bc <-
travellers %>% 
  filter(GEO == "British Columbia",
         REF_DATE == "2020-06")

travellers_bc

```

There are six categories in the `Country of residence` variable. What if we just want a monthly report on a single continent? One of the features of CANSIM and other similar tables is that the individual series are given a single identifier. In the case of CANSIM, these are called the "vector numbers". Scroll to the right on this table, and you'll see a variable called `VECTOR`. The vector identifier (sometimes called "the vector number" even though it's a character string!) for European travellers entering Canada via British Columbia is v32214508.

CANSIM gives us a function to select a single vector number, so we can be more efficient still. We can speed up the download time _and_ skip the filtering steps to get to the one we want. (Note that this function requires us to enter a start date, and converts the reference date variable to the YYYY-MM-DD format.)

```{r}

get_cansim_vector("v32214508", "2015-01-01")

```


There are other very useful functions if you find yourself exploring Statistics Canada data sets. 

The function `get_cansim_table_overview()` provides an abstract about the data table.

```{r}

get_cansim_table_overview("24-10-0006-01")

```


## The BC Data Catalogue

The Province of British Columbia has an open data initiative, that has over 2,000 different data sets published. Some of these are geographic files, but most are data tables. The website for the catalogue is here: https://catalogue.data.gov.bc.ca/dataset?download_audience=Public

The R package {bcdata} has been written to facilitate efficient downloads of data in the Data BC catalogue directly into your R environment.

For this example we will look at the data published about the number of students in the K-12 schools in British Columbia who have one of a variety of special needs: https://catalogue.data.gov.bc.ca/dataset/student-headcount-by-special-needs-category

I have found that the best thing to do is to use the `bcdc_search()` function to find the table I want.

```{r}
bcdc_search("headcount by special needs")
```


You can use the record name or permanent ID in the function `bcdc_get_data()`.



```{r}
special_needs <- bcdc_get_data("1e730ea9-dd19-4c22-aa95-fe644efc7a06")

special_needs <- bcdc_get_data("student-headcount-by-special-needs-category")

```


## REFERENCE MATERIAL

* Statistics Canada 

  - {cansim}: https://mountainmath.github.io/cansim/index.html 
  
  - Dmitry Shkolnik, [The CANSIM package, Canadian tourism, and slopegraphs](https://www.dshkol.com/2018/cansim-package-tourism-slopegraphs/)
  
* BC Data Catalogue 
  
  - {bcdata}: https://bcgov.github.io/bcdata/


### Other R packages to access data

[{censusapi}](https://CRAN.R-project.org/package=censusapi) - Retrieve Data from the Census APIs - "A wrapper for the U.S. Census Bureau APIs that returns data frames of Census data and metadata. Available datasets include the Decennial Census, American Community Survey, Small Area Health Insurance Estimates, Small Area Income and Poverty Estimates, Population Estimates and Projections, and more."  https://CRAN.R-project.org/package=censusapi 

[{eurostat}](https://CRAN.R-project.org/package=eurostat) - Tools for Eurostat Open Data -  https://CRAN.R-project.org/package=eurostat

[{opendatatoronto}](https://sharlagelfand.github.io/opendatatoronto/) - https://sharlagelfand.github.io/opendatatoronto/



***


## APIs

An API is an "Application Programming Interfaces"—a set of instructions or rules that allow software applications to interact with one another. This can happen on one computer or across a network. The packages above embed the rules of the host API to allow us to seamlessly connect. But what if nobody has written a package to connect? Fortunately for those of us who aren't whiz-bang programmers, there are packages to help us with this too.

We may come back to this topic later in the course.



### APIs in R

* [R API Tutorial: Getting Started with APIs in R](https://www.dataquest.io/blog/r-api-tutorial/) -- using the the {httr} and {jsonlite} packages


* [Accessing APIs from R (and a little R programming)](https://www.r-bloggers.com/accessing-apis-from-r-and-a-little-r-programming/)

* [Querying APIs in R](https://medium.com/@traffordDataLab/querying-apis-in-r-39029b73d5f1)

#### R Packages for working with APIs

* {crul} crul: HTTP Client - https://cran.r-project.org/web/packages/crul/ (see vignettes)

* {httr}: https://httr.r-lib.org/

* {jsonlite}: jsonlite: A Simple and Robust JSON Parser and Generator for R https://cran.r-project.org/web/packages/jsonlite/index.html

  - [The jsonlite Package: A Practical and Consistent Mapping Between JSON Data and R Objects](https://arxiv.org/abs/1403.2805)

