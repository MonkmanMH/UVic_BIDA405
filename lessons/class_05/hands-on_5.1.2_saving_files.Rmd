---
title: "Saving files"
subtitle: ""
output:
  html_document:
    df_print: paged
---

<!-- 
This file by Martin Monkman is licensed under a Creative Commons Attribution 4.0 International License. 
-->

```{r setup, message=FALSE, warning=FALSE}
# file read/save packages
library(readr)
library(readxl)
library(openxlsx)
library(feather)

# data wrangling
library(dplyr)

# data
library(gapminder)
```

## Objectives

* Demonstrate understanding of exporting tables and other objects (saving files) in R

* Demonstrate understanding of the pros and cons of each file format, including context for use


## Saving your tables

So far we have covered

* importing data

* validating and cleaning data

* creating summary tables in R and SQL


Now we are at the point where we want to save our efforts. This might be 

* to make the file available to a collaborator; 

* to shift our workflow to another tool (for example, deplying a visualization to Tableau); or

* create a save point in our workflow, so that we can continue our work later but without having to re-do everything we've done.

![Final Fantasy save point](ff7_save_point.gif)

In base R, we can save many file formats. For this exercise, we will focus on the most popular.

## R data files

R data format files (.Rds) make a lot of sense as save points in your workflow. All of the variable types are preserved (e.g. dates and factors) that would be lost in a plain text file.

| function | base R | {readr}
|---|---|---|
|write Rds | `saveRDS()` | `write_rds()` |
|read Rds | `readRDS` | `read_rds()` |


With {readr}: 

* https://readr.tidyverse.org/reference/read_rds.html


In the chunk below, a summary of the {gapminder} table is created with the 2007 GDP per capita, and saved as a .rds file.

```{r}

gm_gdp_2007 <- gapminder %>%
  filter(year == 2007) %>% 
  select(country, continent, year, gdpPercap)

# base R
saveRDS(gm_gdp_2007, "gm_gdp_2007.rds")

# readr
write_rds(gm_gdp_2007, "gm_gdp_2007.rds")

```




## Plain text (CSV)

| function | base R | {readr}
|---|---|---|
|write csv | `write.csv` | `write_csv()` |
|read csv | `read.csv` | `read_csv()` |


With {readr}:

* [writing to CSV](https://rc2e.com/inputandoutput#recipe-id028)


There are of course also options to write a tab-separated value (TSV) or fixed-width file, but CSV are the more familiar type.

See also Hadley Wickham and Garrett Grolemund, _R for Data Science_, [Chapter 11 Data import: 11.5 Writing to a file](https://r4ds.had.co.nz/data-import.html#writing-to-a-file)

```{r}

# base R
write.csv(gm_gdp_2007, "gm_gdp_2007.csv")

# readr
write_csv(gm_gdp_2007, "gm_gdp_2007.csv")

```


## Excel files

Excel files are everywhere, because Excel is everywhere. In a lot of circumstances, you will find that the downstream consumers of your data tables will explicitly ask for their tables to be in Excel.

Two packages provide a full suite of functionality for working with Excel files. For straight-forward saving, {writexl} is arguably the better of the two. 

{writexl}:

* [The writexl package](https://docs.ropensci.org/writexl/)


The other package, {openxlsx}, has a huge amount of functionality. This package gives you a great deal of power to add formatting, named ranges, and other artifacts to your Excel output.

```{r}
write.xlsx(gm_gdp_2007, file = "gm_gdp_2007.xlsx")

# to write as an Excel table
write.xlsx(gm_gdp_2007, file = "gm_gdp_2007_1.xlsx", asTable = TRUE)
```

You can also write a list of data tables to a single Excel file.

```{r}
# create data table with opulation instead of gdp
gm_pop_2007 <- gapminder %>%
  filter(year == 2007) %>% 
  select(country, continent, year, pop)

# create a list of the data tables
dfs <- list("GDP" = gm_gdp_2007, "Population" = gm_pop_2007)

write.xlsx(dfs, file = "gm_tables.xlsx", asTable = TRUE)


```


It is also possible to start a workbook from scratch and add default formatting:

```{r}
# create workbook object
wb <- createWorkbook()

# set various format options
options("openxlsx.borderColour" = "#4F80BD")
options("openxlsx.borderStyle" = "thin")
modifyBaseFont(wb, fontSize = 10, fontName = "Arial Narrow")

# add a sheet named GDP
addWorksheet(wb, sheetName = "GDP", gridLines = FALSE)

freezePane(wb, sheet = 1, firstRow = TRUE, firstCol = TRUE) ## freeze first row and column
# write the GDP data object to the sheet
writeDataTable(wb, sheet = 1, x = gm_gdp_2007,
               colNames = TRUE, rowNames = TRUE,
               tableStyle = "TableStyleLight9")

# more format
setColWidths(wb, sheet = 1, cols = "A", widths = 18)

# and save
saveWorkbook(wb, "gm_gdp.xlsx")
```




{openxlsx}: Read, Write and Edit xlsx Files}

* CRAN site https://cran.r-project.org/package=openxlsx

* Reference site: https://ycphs.github.io/openxlsx/index.html

* [_R Cookbook_, 2nd ed.: Writing a Data Frame to Excel](https://rc2e.com/inputandoutput#recipe-writeexcel)



## Other formats


### {feather}


### database





***

## REFERENCE

### Packages

{readr}: https://readr.tidyverse.org/index.html

{readxls}: 


## Other references


Buttery and Neild, Chapter 6 Getting Data into and out of R



### SQLite

[SQLite tutorial](https://www.sqlitetutorial.net/)

* [Export SQLite Database To a CSV File](https://www.sqlitetutorial.net/sqlite-tutorial/sqlite-export-csv/)

* [SQLite functions](https://www.sqlitetutorial.net/sqlite-functions/)




### SQL

Thomas Nield, _Getting Started with SQL: A Hands-On Approach for Beginners_ (2016)

* Chapter 2, "Databases"

* Chapter 9, "Database design"

* Installing SQLite: Chapter 3, "SQLite"

* [UVic Library link](https://proquestcombo-safaribooksonline-com.ezproxy.library.uvic.ca/9781491938607?ar&orpq&email=oJbr4Ho8VLXz0zbFzjLK2g%3d%3d&tstamp=1600913295&id=2C359E41B596290424E03BF0F243BBA36BFDDBFA)


### SQL from R Markdown

[_R Markdown: The Definitive Guide_, 2.7.3 SQL](https://bookdown.org/yihui/rmarkdown/language-engines.html#sql) by Yihui Xie, J. J. Allaire, Garrett Grolemund

* instructions on how to set up your R Markdown (in RStudio) so that you can run SQL language chunks, including using SQLite


